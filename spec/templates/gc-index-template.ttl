@prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> .
@prefix idx: <https://w3id.org/solid-crdt-sync/vocab/idx#> .
@prefix crdt: <https://w3id.org/solid-crdt-sync/vocab/crdt-mechanics#> .
@prefix sync: <https://w3id.org/solid-crdt-sync/vocab/sync#> .
@prefix mappings: <https://w3id.org/solid-crdt-sync/mappings/> .

# Template for Framework Garbage Collection Index
# System-level index for tracking tombstoned documents requiring cleanup
# Indexes document types that can be deleted: ManagedDocument, FullIndex, GroupIndex, Shard
# Placeholders: {INSTALLATION_URI}

<> a idx:GroupIndexTemplate;
   sync:isGovernedBy mappings:index-v1;
   # Minimal clock ensures template participates in CRDT merging but loses tie-breaking
   crdt:hasClockEntry [
     crdt:installationId <{INSTALLATION_URI}>;
     crdt:logicalTime 1;
     crdt:physicalTime 0
   ] ;
   idx:indexesClass sync:ManagedDocument, idx:FullIndex, idx:GroupIndex, idx:GroupIndexTemplate, idx:Shard ;  # Document types that can be deleted
   idx:indexedProperty [
     a idx:IndexedProperty ;
     idx:trackedProperty crdt:deletedAt ;
     idx:readBy <{INSTALLATION_URI}>
   ], [
     a idx:IndexedProperty ;
     idx:trackedProperty crdt:createdAt ;    # Needed for temporal lifecycle evaluation
     idx:readBy <{INSTALLATION_URI}>
   ], [
     a idx:IndexedProperty ;
     idx:trackedProperty rdf:type ;
     idx:readBy <{INSTALLATION_URI}>
   ], [
     a idx:IndexedProperty ;
     idx:trackedProperty sync:managedResourceType ;  # For ManagedDocument retention policies
     idx:readBy <{INSTALLATION_URI}>
   ], [
     a idx:IndexedProperty ;
     idx:trackedProperty idx:indexesClass ;  # For index retention policies
     idx:readBy <{INSTALLATION_URI}>
   ] ;
   idx:groupedBy [
     a idx:GroupingRule;
     idx:property [
       a idx:GroupingRuleProperty;
       idx:sourceProperty crdt:deletedAt;
       idx:transform (
         [
           a idx:RegexTransform;
           idx:pattern "^([0-9]{4})-[0-9]{2}-[0-9]{2}$";
           idx:replacement "${1}"
         ]
       ) .
       # No idx:missingValue = documents without deletedAt create no groups
     ]
     # No groupTemplate - paths generated deterministically as: gc/{year}/index
   ];
   # Standard sharding for GC index
   idx:shardingAlgorithm [
     a idx:ModuloHashSharding;
     idx:hashAlgorithm "xxhash64";
     idx:numberOfShards 1
   ];
   idx:populationState "active";
   idx:readBy <{INSTALLATION_URI}> .